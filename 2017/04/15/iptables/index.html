<html>
<head>
	
	<title>iptables</title>
	<meta name="keywords" content="fzb.me,冯宗宝,冯宗宝的blog" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/css/main.css?v=3" rel="stylesheet" type="text/css" />
    
        <script src="/js/util.js"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3"/>
    

</head>

<body>


<h2 class="title">iptables</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2017年4月15日


    <a class="article-category-link" href="/categories/Linux/">Linux</a>



 </div>
--->
</div>

<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、iptables表和链的结构-四表五链"><span class="toc-text">一、iptables表和链的结构(四表五链)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-四张表处理优先级-raw-gt-mangle-gt-nat-gt-filter"><span class="toc-text">1.四张表处理优先级: raw&gt;mangle&gt;nat&gt;filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-五链：INPUT-FORWARD-OUTPUT-PREROUTING-POSTROUTING"><span class="toc-text">2.五链：INPUT, FORWARD, OUTPUT, PREROUTING, POSTROUTING</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-iptables常用参数"><span class="toc-text">3.iptables常用参数:</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、配置filter表防火墙"><span class="toc-text">二、配置filter表防火墙</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#tip-一般设置默认规则-INPUT链和FORWARD链为DROP-OUTPUT链为ACCEPT"><span class="toc-text">tip: 一般设置默认规则,INPUT链和FORWARD链为DROP , OUTPUT链为ACCEPT</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-清除预设表filter中的所有规则链的规则"><span class="toc-text">1.清除预设表filter中的所有规则链的规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-清除预设表filter中使用者自定链中的规则"><span class="toc-text">2.清除预设表filter中使用者自定链中的规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-设定预设规则"><span class="toc-text">3.设定预设规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-根据自己机器的实际情况开启相应端口"><span class="toc-text">4.根据自己机器的实际情况开启相应端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-保存iptables配置"><span class="toc-text">5.保存iptables配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-重启iptables服务"><span class="toc-text">6.重启iptables服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-查看iptables规则"><span class="toc-text">7.查看iptables规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-iptables优化"><span class="toc-text">8.iptables优化:</span></a></li></ol></li></ol></li></ol>
<a id="more"></a>
<h1 id="一、iptables表和链的结构-四表五链"><a href="#一、iptables表和链的结构-四表五链" class="headerlink" title="一、iptables表和链的结构(四表五链)"></a>一、iptables表和链的结构(四表五链)</h1><h3 id="1-四张表处理优先级-raw-gt-mangle-gt-nat-gt-filter"><a href="#1-四张表处理优先级-raw-gt-mangle-gt-nat-gt-filter" class="headerlink" title="1.四张表处理优先级: raw&gt;mangle&gt;nat&gt;filter"></a>1.四张表处理优先级: raw&gt;mangle&gt;nat&gt;filter</h3><p><strong>raw:</strong> 优先级最高, 设置raw一般是为了不再让iptables做数据包的跟踪链接处理, 提高性能.</p>
<p><strong>mangle:</strong> 用于对特定数据包的修改.</p>
<p><strong>nat:</strong> 用于nat功能端口或者地址映射.</p>
<p><strong>filter:</strong> 一般的过滤功能.</p>
<h3 id="2-五链：INPUT-FORWARD-OUTPUT-PREROUTING-POSTROUTING"><a href="#2-五链：INPUT-FORWARD-OUTPUT-PREROUTING-POSTROUTING" class="headerlink" title="2.五链：INPUT, FORWARD, OUTPUT, PREROUTING, POSTROUTING"></a>2.五链：INPUT, FORWARD, OUTPUT, PREROUTING, POSTROUTING</h3><p><strong>raw表</strong>中的链有: PREROUTING, OUTPUT</p>
<p><strong>mangle表</strong>中的链有: PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING</p>
<p><strong>nat表</strong>中的链有: PREROUTING, POSTROUTING, OUTPUT</p>
<p><strong>filter表</strong>中的链有: INPUT, FORWARD, OUTPUT</p>
<h3 id="3-iptables常用参数"><a href="#3-iptables常用参数" class="headerlink" title="3.iptables常用参数:"></a>3.iptables常用参数:</h3><p>tip: iptable -h都能看到对应的解释</p>
<p><strong>规则增删改查:</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">-A</td>
<td style="text-align:left">在规则链的末尾加入新规则</td>
</tr>
<tr>
<td style="text-align:left">-I</td>
<td style="text-align:left">在规则链的头部加入新规则</td>
</tr>
<tr>
<td style="text-align:left">-D</td>
<td style="text-align:left">删除</td>
</tr>
<tr>
<td style="text-align:left">-R</td>
<td style="text-align:left">修改</td>
</tr>
<tr>
<td style="text-align:left">-L</td>
<td style="text-align:left">查看</td>
</tr>
<tr>
<td style="text-align:left">-P</td>
<td style="text-align:left">设置默认策略 , iptables -P INPUT DROP</td>
</tr>
<tr>
<td style="text-align:left">-F</td>
<td style="text-align:left">清空默认规则链</td>
</tr>
<tr>
<td style="text-align:left">-X</td>
<td style="text-align:left">删除自定义空链</td>
</tr>
<tr>
<td style="text-align:left">-N</td>
<td style="text-align:left">定义新的规则</td>
</tr>
</tbody>
</table>
<p><strong>常用参数:</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">-p</td>
<td style="text-align:left">指定协议 tcp/udp/icmp</td>
</tr>
<tr>
<td style="text-align:left">-s</td>
<td style="text-align:left">指定源地址 ip/mask , 加叹号 “!” 表示相反的意思</td>
</tr>
<tr>
<td style="text-align:left">-d</td>
<td style="text-align:left">匹配目标地址</td>
</tr>
<tr>
<td style="text-align:left">–sport</td>
<td style="text-align:left">匹配来源端口号</td>
</tr>
<tr>
<td style="text-align:left">–dport</td>
<td style="text-align:left">匹配目端口号</td>
</tr>
<tr>
<td style="text-align:left">-i</td>
<td style="text-align:left">匹配从这块网卡流入的数据</td>
</tr>
<tr>
<td style="text-align:left">-o</td>
<td style="text-align:left">匹配从这块网卡流出的数据</td>
</tr>
<tr>
<td style="text-align:left">-m</td>
<td style="text-align:left">加载模块</td>
</tr>
<tr>
<td style="text-align:left">-t</td>
<td style="text-align:left">指定表, 默认filter表. iptables -L - nat/mangle/raw</td>
</tr>
<tr>
<td style="text-align:left">-j</td>
<td style="text-align:left">指定处理的动作 , ACCEPT/DROP</td>
</tr>
</tbody>
</table>
<p><strong>常用处理动作:</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">动作</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ACCEPT</td>
<td style="text-align:left">允许封包通过,:将数据包放行,进行完此动作后,不再对比其他规则,直接跳往下一个规则链.</td>
</tr>
<tr>
<td style="text-align:left">DROP</td>
<td style="text-align:left">丢弃封包,响应超时,对方无法判断主机是否在线或者流量被拒绝,不再对比其他规则,中断过滤.</td>
</tr>
<tr>
<td style="text-align:left">REJECT</td>
<td style="text-align:left">拒绝封包通过,并将数据包封装,返回消息,对方看到主机口不可达.</td>
</tr>
<tr>
<td style="text-align:left">REDIRECT</td>
<td style="text-align:left">将包重定向到另一个端口,之后继续对比其他规则.</td>
</tr>
<tr>
<td style="text-align:left">MASQUERADE</td>
<td style="text-align:left">改写封包来源ip为防火墙NIC ip , 可指定port范围 , 之后跳往下一规则.</td>
</tr>
<tr>
<td style="text-align:left">SNAT</td>
<td style="text-align:left">改写封包来源ip为某特定ip或ip范围 , 可指定 port 范围 , 之后跳往下一规则.</td>
</tr>
<tr>
<td style="text-align:left">DNAT</td>
<td style="text-align:left">改写封包目的ip为某特定ip或ip范围, 可指定port范围 , 之后跳往下一规则.</td>
</tr>
</tbody>
</table>
<h1 id="二、配置filter表防火墙"><a href="#二、配置filter表防火墙" class="headerlink" title="二、配置filter表防火墙"></a>二、配置filter表防火墙</h1><h6 id="tip-一般设置默认规则-INPUT链和FORWARD链为DROP-OUTPUT链为ACCEPT"><a href="#tip-一般设置默认规则-INPUT链和FORWARD链为DROP-OUTPUT链为ACCEPT" class="headerlink" title="tip: 一般设置默认规则,INPUT链和FORWARD链为DROP , OUTPUT链为ACCEPT"></a>tip: 一般设置默认规则,INPUT链和FORWARD链为DROP , OUTPUT链为ACCEPT</h6><h3 id="1-清除预设表filter中的所有规则链的规则"><a href="#1-清除预设表filter中的所有规则链的规则" class="headerlink" title="1.清除预设表filter中的所有规则链的规则"></a>1.清除预设表filter中的所有规则链的规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br></pre></td></tr></table></figure>
<h3 id="2-清除预设表filter中使用者自定链中的规则"><a href="#2-清除预设表filter中使用者自定链中的规则" class="headerlink" title="2.清除预设表filter中使用者自定链中的规则"></a>2.清除预设表filter中使用者自定链中的规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -X</span><br></pre></td></tr></table></figure>
<h3 id="3-设定预设规则"><a href="#3-设定预设规则" class="headerlink" title="3.设定预设规则"></a>3.设定预设规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br><span class="line">iptables -P FORWARD DROP</span><br></pre></td></tr></table></figure>
<h3 id="4-根据自己机器的实际情况开启相应端口"><a href="#4-根据自己机器的实际情况开启相应端口" class="headerlink" title="4.根据自己机器的实际情况开启相应端口"></a>4.根据自己机器的实际情况开启相应端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许回环loopback访问</span></span><br><span class="line">$ iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -o lo -j ACCEPT   (output链的默认策略设置为DROP时,需要添加这条,以下针对的每个端口同此一样.)</span><br><span class="line"><span class="comment">#开启22端口,ssh才能登录.</span></span><br><span class="line">$ iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line">或者</span><br><span class="line">$ iptables -A INPUT -i eth0 -s 192.168.2.100 -p tcp --dport 22 -j ACCEPT <span class="comment">#指定eth1网卡和192.168.2.100允许ssh登录</span></span><br><span class="line">$ iptables -A OUTPUT -o eth0 -s 192.168.2.100 -p tcp --dport 22 -j ACCEPT</span><br><span class="line"><span class="comment">#允许ping(即icmp包通过)</span></span><br><span class="line">$ iptables -A INPUT -p icmp -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -p icmp -j ACCEPT</span><br><span class="line"><span class="comment">#使ping域名可以得到响应</span></span><br><span class="line">$ iptables -A INPUT -p udp --sport 53 -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -p udp --dport 53 -j ACCEPT</span><br><span class="line">$ iptables -A INPUT -p udp --dport 53 -j ACCEPT</span><br><span class="line">$ iptables -A OUTPUT -p udp --sport 53 -j ACCEPT</span><br><span class="line">tip: 除了以上用命令去添加规则,还可以用编辑文件的方式 vim /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure>
<h3 id="5-保存iptables配置"><a href="#5-保存iptables配置" class="headerlink" title="5.保存iptables配置"></a>5.保存iptables配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables save</span><br></pre></td></tr></table></figure>
<h3 id="6-重启iptables服务"><a href="#6-重启iptables服务" class="headerlink" title="6.重启iptables服务"></a>6.重启iptables服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables restart</span><br></pre></td></tr></table></figure>
<h3 id="7-查看iptables规则"><a href="#7-查看iptables规则" class="headerlink" title="7.查看iptables规则"></a>7.查看iptables规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -L -n</span><br></pre></td></tr></table></figure>
<h3 id="8-iptables优化"><a href="#8-iptables优化" class="headerlink" title="8.iptables优化:"></a>8.iptables优化:</h3><p>请求比较频繁的放在最上面,请求频率较小的放在最后面.这里整理关于防火墙的东西,不是具体的知识,更多工操作使用,具体的防火墙知识,还需要去阅读参考网上写的各种文章,需要多读多看多试,才能理解深入.</p>


<!--<a href="http://cyoncan.github.io/2017/04/15/iptables/#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = ''; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=&web_id=" language="JavaScript"></script>script>
</div>






</body>
</html>